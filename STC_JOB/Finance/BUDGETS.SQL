TRUNCATE TABLE STC_FACT_F_BUD;
COMMIT;
INSERT INTO STC_FACT_F_BUD
(
 BH_SYS_ID
,BH_COMP_CODE
,BH_TXN_CODE
,BH_NO
,BH_DT
,BH_TYPE_NUM
,BH_BC_CODE
,BH_BP_CODE
,BH_BLH_CODE
,BH_BPD_FM_DT
,BH_BPD_TO_DT
,BH_BG_CODE
,BH_REMARKS
,BH_STATUS
,BH_SUBMIT_STATUS
,BH_APPR_STATUS
,BH_APPR_UID
,BH_APPR_DT
,BH_AMD_NO
,BH_AMD_DT
,BH_AMD_RES_CODE
,BH_AMD_USER_ID
,BH_FLEX_01
,BH_FLEX_02
,BH_FLEX_03
,BH_FLEX_04
,BH_FLEX_05
,BH_FLEX_06
,BH_FLEX_07
,BH_FLEX_08
,BH_FLEX_09
,BH_FLEX_10
,BH_FLEX_11
,BH_FLEX_12
,BH_FLEX_13
,BH_FLEX_14
,BH_FLEX_15
,BH_FLEX_16
,BH_FLEX_17
,BH_FLEX_18
,BH_FLEX_19
,BH_FLEX_20
,BH_CR_UID
,BH_CR_DT
,BH_UPD_UID
,BH_UPD_DT
,BD_SYS_ID
,BD_BH_SYS_ID
,BD_REF_SYS_ID
,BD_BCD_SEG_CODE_01
,BD_BCD_SEG_VALUE_01
,BD_BCD_SEG_CODE_02
,BD_BCD_SEG_VALUE_02
--,nvl(BD_BCD_SEG_VALUE_02,'0')  BD_BCD_SEG_VALUE_02_LK
,BD_BCD_SEG_CODE_03
,BD_BCD_SEG_VALUE_03
,BD_BCD_SEG_CODE_04
,BD_BCD_SEG_VALUE_04
,BD_BCD_SEG_CODE_05
,BD_BCD_SEG_VALUE_05
,BD_BCD_SEG_CODE_06
,BD_BCD_SEG_VALUE_06
,BD_BCD_SEG_CODE_07
,BD_BCD_SEG_VALUE_07
,BD_BCD_SEG_CODE_08
,BD_BCD_SEG_VALUE_08
,BD_BCD_SEG_CODE_09
,BD_BCD_SEG_VALUE_09
,BD_BCD_SEG_CODE_10
,BD_BCD_SEG_VALUE_10
,BD_BCD_SEG_CODE_11
,BD_BCD_SEG_VALUE_11
,BD_BCD_SEG_CODE_12
,BD_BCD_SEG_VALUE_12
,BD_BLH_CODE
,BD_BG_CODE
,BD_DESCRIPTION
,BD_BP_CODE
,BD_SUB_BP_CODE_REQ_NUM
,BD_SUB_BP_CODE
,BD_QTY_VALUE_NUM
,BD_RATE_VALUE_NUM
,BD_UOM_CODE
,BD_ORG_QTY
,BD_ORG_QTY_LS
,BD_ORG_QTY_BU
,BD_ORG_RATE
,BD_ORG_AMT
,BD_CONF_YN_NUM
,BD_CONF_QTY
,BD_CONF_QTY_LS
,BD_CONF_QTY_BU
,BD_CONF_RATE
,BD_CONF_AMT
,BD_REMARKS
,BD_FLEX_01
,BD_FLEX_02
,BD_FLEX_03
,BD_FLEX_04
,BD_FLEX_05
,BD_FLEX_06
,BD_FLEX_07
,BD_FLEX_08
,BD_FLEX_09
,BD_FLEX_10
,BD_FLEX_11
,BD_FLEX_12
,BD_FLEX_13
,BD_FLEX_14
,BD_FLEX_15
,BD_FLEX_16
,BD_FLEX_17
,BD_FLEX_18
,BD_FLEX_19
,BD_FLEX_20
,BD_CR_UID
,BD_CR_DT
,BD_UPD_UID
,BD_UPD_DT
--,case  when BD_BCD_SEG_VALUE_01 like '3%' then (1*bd_conf_amt) --end BD_BCD_SEG_VALUE_00
--when BD_BCD_SEG_VALUE_01 like '4%' then ((-1)*(bd_conf_amt)) end BD_BCD_SEG_VALUE_00
,PROG_FLEX_NUM_01
,PROG_CR_DT
,PROG_FLEX_NUM_02-----b.bd_conf_amt/(c.cy_end_date - c.cy_st_date) as D_CONF_AMNT,
,PROG_FLEX_DT_01--c.ddate,
,PROG_FLEX_NUM_03---(c.cy_end_date - c.cy_st_date) no_days,
,PROG_FLEX_DT_03----c.cy_st_date
,TRAN_ID
,BUD_HIERARCHY_ID
,BUD_PERIOD_ID
,BUD_CAT_ID
)
SELECT
 A.BH_SYS_ID
,A.BH_COMP_CODE
,A.BH_TXN_CODE
,A.BH_NO
,A.BH_DT
,A.BH_TYPE_NUM
,A.BH_BC_CODE
,A.BH_BP_CODE
,A.BH_BLH_CODE
,A.BH_BPD_FM_DT
,A.BH_BPD_TO_DT
,A.BH_BG_CODE
,A.BH_REMARKS
,A.BH_STATUS
,A.BH_SUBMIT_STATUS
,A.BH_APPR_STATUS
,A.BH_APPR_UID
,A.BH_APPR_DT
,A.BH_AMD_NO
,A.BH_AMD_DT
,A.BH_AMD_RES_CODE
,A.BH_AMD_USER_ID
,A.BH_FLEX_01
,A.BH_FLEX_02
,A.BH_FLEX_03
,A.BH_FLEX_04
,A.BH_FLEX_05
,A.BH_FLEX_06
,A.BH_FLEX_07
,A.BH_FLEX_08
,A.BH_FLEX_09
,A.BH_FLEX_10
,A.BH_FLEX_11
,A.BH_FLEX_12
,A.BH_FLEX_13
,A.BH_FLEX_14
,A.BH_FLEX_15
,A.BH_FLEX_16
,A.BH_FLEX_17
,A.BH_FLEX_18
,A.BH_FLEX_19
,A.BH_FLEX_20
,A.BH_CR_UID
,A.BH_CR_DT
,A.BH_UPD_UID
,A.BH_UPD_DT
,B.BD_SYS_ID
,B.BD_BH_SYS_ID
,B.BD_REF_SYS_ID
,B.BD_BCD_SEG_CODE_01
,B.BD_BCD_SEG_VALUE_01
,B.BD_BCD_SEG_CODE_02
,B.BD_BCD_SEG_VALUE_02
--,nvl(B.BD_BCD_SEG_VALUE_02,'0')  BD_BCD_SEG_VALUE_02_LK
,B.BD_BCD_SEG_CODE_03
,B.BD_BCD_SEG_VALUE_03
,B.BD_BCD_SEG_CODE_04
,B.BD_BCD_SEG_VALUE_04
,B.BD_BCD_SEG_CODE_05
,B.BD_BCD_SEG_VALUE_05
,B.BD_BCD_SEG_CODE_06
,B.BD_BCD_SEG_VALUE_06
,B.BD_BCD_SEG_CODE_07
,B.BD_BCD_SEG_VALUE_07
,B.BD_BCD_SEG_CODE_08
,B.BD_BCD_SEG_VALUE_08
,B.BD_BCD_SEG_CODE_09
,B.BD_BCD_SEG_VALUE_09
,B.BD_BCD_SEG_CODE_10
,B.BD_BCD_SEG_VALUE_10
,B.BD_BCD_SEG_CODE_11
,B.BD_BCD_SEG_VALUE_11
,B.BD_BCD_SEG_CODE_12
,B.BD_BCD_SEG_VALUE_12
,B.BD_BLH_CODE
,B.BD_BG_CODE
,B.BD_DESCRIPTION
,B.BD_BP_CODE
,B.BD_SUB_BP_CODE_REQ_NUM
,B.BD_SUB_BP_CODE
,B.BD_QTY_VALUE_NUM
,B.BD_RATE_VALUE_NUM
,B.BD_UOM_CODE
,B.BD_ORG_QTY
,B.BD_ORG_QTY_LS
,B.BD_ORG_QTY_BU
,B.BD_ORG_RATE
,B.BD_ORG_AMT
,B.BD_CONF_YN_NUM
,B.BD_CONF_QTY
,B.BD_CONF_QTY_LS
,B.BD_CONF_QTY_BU
,B.BD_CONF_RATE
,B.BD_CONF_AMT
,B.BD_REMARKS
,B.BD_FLEX_01
,B.BD_FLEX_02
,B.BD_FLEX_03
,B.BD_FLEX_04
,B.BD_FLEX_05
,B.BD_FLEX_06
,B.BD_FLEX_07
,B.BD_FLEX_08
,B.BD_FLEX_09
,B.BD_FLEX_10
,B.BD_FLEX_11
,B.BD_FLEX_12
,B.BD_FLEX_13
,B.BD_FLEX_14
,B.BD_FLEX_15
,B.BD_FLEX_16
,B.BD_FLEX_17
,B.BD_FLEX_18
,B.BD_FLEX_19
,B.BD_FLEX_20
,B.BD_CR_UID
,B.BD_CR_DT
,B.BD_UPD_UID
,B.BD_UPD_DT
,case  when BD_BCD_SEG_VALUE_01 like '3%' then (1*bd_conf_amt) --end BD_BCD_SEG_VALUE_00
when BD_BCD_SEG_VALUE_01 like '4%' then ((-1)*(bd_conf_amt)) end BD_BCD_SEG_VALUE_00
,sysdate
,b.bd_conf_amt/(c.cy_end_date - c.cy_st_date) as D_CONF_AMNT
,c.ddate
,(c.cy_end_date - c.cy_st_date) no_days
,c.cy_st_date
,STC_DIM_TXN.TXN_ID
,STC_DIM_F_BUD_HIERARCHY.BUD_HIERARCHY_ID
,STC_DIM_F_BUD_PERIOD.BUD_PERIOD_ID
,STC_DIM_F_BUD_CAT.BUD_CAT_ID
FROM IT_BUD_HEAD@STCBI A
left outer join STC_DIM_TXN STC_DIM_TXN on
(a.BH_TXN_CODE = STC_DIM_TXN.TXN_CODE)---------STC_DIM_TXN.TXN_ID
left outer join STC_DIM_F_BUD_CAT STC_DIM_F_BUD_CAT on
(a.BH_BC_CODE = BC_CODE)--------STC_DIM_F_BUD_CAT.BUD_CAT_ID
left outer join STC_DIM_F_BUD_PERIOD STC_DIM_F_BUD_PERIOD on
(A.BH_BP_CODE =  BP_CODE AND
A.BH_BPD_FM_DT = BPD_FM_DT AND
A.BH_BPD_TO_DT = BPD_TO_DT) , --STC_DIM_F_BUD_PERIOD.BUD_PERIOD_ID,
IT_BUD_DETAIL@STCBI B
left outer join STC_DIM_F_BUD_HIERARCHY STC_DIM_F_BUD_HIERARCHY on
(B.bd_blh_code = STC_DIM_F_BUD_HIERARCHY.BHD_BLH_CODE)-----STC_DIM_F_BUD_HIERARCHY.BUD_HIERARCHY_ID
,pr_day_denom C
where A.BH_SYS_ID = B.BD_BH_SYS_ID and a.bh_bpd_fm_dt = C.cy_st_date AND
to_date(A.BH_CR_DT,'DD-MM-YYYY')>=TO_DATE('1-JULY-03','DD-MM-YYYY')  and
to_date(A.BH_CR_DT,'DD-MM-YYYY')< TO_DATE(SYSDATE,'DD-MM-YYYY');
COMMIT;
update stcbi106.STC_FACT_F_BUD a set a.grp_comp_id = 
(select b.grp_comp_id from stcbi106.stc_dim_group_companies b where 
b.COMPANY_CODE = a.BH_COMP_CODE and 
a.BD_BCD_SEG_VALUE_01 = b.MAIN_ACCOUNT_CODE and
nvl(a.BD_BCD_SEG_VALUE_02,'0') = b.SUB_ACCOUNT_CODE);
commit;
update stc_fact_f_bud a set a.prog_flex_num_04 = (select b.comp_id from stc_dim_companies b where a.BH_COMP_CODE = b.company_code);
commit;
UPDATE STC_FACT_F_BUD SET PROG_FLEX_NUM_02 = ((-1)*(PROG_FLEX_NUM_02)) WHERE PROG_FLEX_NUM_01 LIKE '-%';
COMMIT;